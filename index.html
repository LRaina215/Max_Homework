<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project RED: èµ›åšé©¬å…‹æ€ | ç©¿è¶Šæ—¶ç©ºçš„è¾©è¯æ³•</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-red: #ff2a2a;
            --gold: #ffd700;
            --bg-color: #050505;
            --glass: rgba(20, 20, 20, 0.85);
        }

        body, html { margin: 0; padding: 0; overflow-x: hidden; background-color: var(--bg-color); color: #e0e0e0; font-family: 'Courier New', 'Segoe UI', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--primary-red); border-radius: 4px; }

        /* === å¯åŠ¨é¡µæ ·å¼ (æ–°å¢) === */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease;
        }
        .start-btn {
            padding: 15px 40px; border: 2px solid var(--primary-red); color: var(--primary-red);
            background: transparent; font-size: 1.2rem; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 3px; transition: 0.3s;
            animation: pulse 2s infinite;
        }
        .start-btn:hover { background: var(--primary-red); color: #fff; box-shadow: 0 0 30px var(--primary-red); }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 42, 42, 0.4);} 70% {box-shadow: 0 0 0 20px rgba(255, 42, 42, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 42, 42, 0);} }

        /* å¯¼èˆªæ  */
        nav { position: fixed; top: 0; width: 100%; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); border-bottom: 1px solid rgba(255, 42, 42, 0.3); }
        .logo { font-weight: 900; font-size: 1.2rem; color: var(--primary-red); letter-spacing: 2px; text-transform: uppercase; }
        
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: -1; }

        .content { position: relative; z-index: 10; width: 100%; max-width: 1200px; margin: 0 auto; opacity: 0; transition: opacity 1s; } /* åˆå§‹éšè—å†…å®¹ */

        /* ä¿®å¤æ»šåŠ¨ BUG çš„å…³é”®ï¼šç»™ section ä¸€ä¸ªæœ€å°é«˜åº¦ï¼Œç¡®ä¿ ScrollTrigger èƒ½è®¡ç®—åˆ° */
        .section { 
            min-height: 80vh; /* ç¡®ä¿æ¯å±æœ‰è¶³å¤Ÿé«˜åº¦ */
            padding: 50px 20px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            position: relative; 
        }
        
        .hero { min-height: 100vh; justify-content: center; }
        
        h1 { font-size: clamp(3rem, 8vw, 6rem); margin: 0; line-height: 1; color: #fff; text-shadow: 0 0 20px rgba(255, 42, 42, 0.5); }
        h1 span { color: var(--primary-red); }
        
        .hero-desc { margin-top: 30px; font-size: 1.2rem; border-left: 4px solid var(--gold); padding-left: 15px; color: #fff; max-width: 700px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 0 10px 10px 0; }

        .card-container { display: flex; flex-direction: column; gap: 30px; width: 100%; }
        .theory-card { 
            background: var(--glass); 
            border: 1px solid rgba(255, 42, 42, 0.3); 
            padding: 30px; 
            border-radius: 8px; 
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .theory-card:hover { border-color: var(--gold); }
        .theory-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary-red); }
        .theory-card h2 { color: var(--gold); margin-top: 0; font-size: 1.8rem; }
        .theory-card p { line-height: 1.8; color: #ddd; font-size: 1.05rem; text-align: justify; }

        .highlight { color: var(--primary-red); font-weight: bold; background: rgba(255, 42, 42, 0.1); padding: 0 4px; }

        /* AI èŠå¤©æ ·å¼ */
        .chat-section { padding-bottom: 100px; }
        .chat-container {
            width: 100%; height: 600px; background: rgba(0, 0, 0, 0.85);
            border: 1px solid var(--primary-red); border-radius: 10px;
            display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(255, 42, 42, 0.15); overflow: hidden;
        }
        .chat-header { padding: 15px 20px; background: rgba(255, 42, 42, 0.15); border-bottom: 1px solid var(--primary-red); display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 10px; height: 10px; background: #00ff00; border-radius: 50%; box-shadow: 0 0 10px #00ff00; margin-right: 10px; display: inline-block; }
        .chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 85%; padding: 15px; border-radius: 8px; line-height: 1.6; font-size: 0.95rem; }
        .message.user { align-self: flex-end; background: #333; color: #fff; border: 1px solid #555; }
        .message.ai { align-self: flex-start; background: rgba(60, 0, 0, 0.6); border: 1px solid var(--primary-red); color: #ffd1d1; }
        .chat-input-area { padding: 20px; background: #111; display: flex; gap: 10px; border-top: 1px solid #333; }
        input[type="text"] { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 15px; border-radius: 4px; font-family: inherit; font-size: 1rem; }
        input[type="text"]:focus { outline: none; border-color: var(--primary-red); background: #000; }
        button { background: var(--primary-red); color: #fff; border: none; padding: 0 30px; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.3s; font-size: 1rem; }

        /* éŸ³ä¹æ§åˆ¶æŒ‰é’® */
        .music-control { position: fixed; bottom: 20px; right: 20px; z-index: 1001; cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .music-control:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

    <!-- èƒŒæ™¯éŸ³ä¹ï¼šç¡®ä¿ä½ çš„ç›®å½•ä¸‹æœ‰ music.mp3 -->
    <audio id="bgm" loop>
        <source src="music.mp3" type="audio/mpeg">
    </audio>

    <!-- å¯åŠ¨å°é¢ -->
    <div id="start-screen">
        <h1 style="font-size: 2rem; margin-bottom: 30px; text-align: center;">RED PROJECT</h1>
        <button class="start-btn" onclick="startExperience()">è¿›å…¥æ€æƒ³çŸ©é˜µ / ENTER</button>
        <p style="margin-top: 20px; color: #666; font-size: 0.8rem;">ğŸ§ ä½©æˆ´è€³æœºä½“éªŒæœ€ä½³</p>
    </div>

    <!-- éŸ³ä¹å¼€å…³å›¾æ ‡ -->
    <div class="music-control" onclick="toggleMusic()" title="åˆ‡æ¢éŸ³ä¹">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#ff2a2a" stroke-width="2">
            <path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle>
        </svg>
    </div>

    <nav>
        <div class="logo">RED_PROJECT // 1818-202X</div>
        <div style="font-size: 0.8rem; color: #aaa;">CS x MARXISM</div>
    </nav>

    <div id="canvas-container"></div>

    <div class="content" id="main-content">
        <!-- 1. é¦–é¡µ Hero -->
        <div class="section hero">
            <h1>CYBER <br><span>MARX</span></h1>
            <div class="hero-desc">
                <p id="typewriter"></p>
            </div>
            <div style="margin-top: 50px; opacity: 0.6; font-size: 0.9rem;">
                â†“ å‘ä¸‹æ»šåŠ¨
            </div>
        </div>

        <!-- 2. æ·±åº¦å†…å®¹ï¼šå¼€æº -->
        <div class="section scroll-reveal">
            <div class="card-container">
                <div class="theory-card">
                    <h2>01 / æ•°å­—å…¬æœ‰åˆ¶</h2>
                    <h3>ä»ã€Šèµ„æœ¬è®ºã€‹åˆ° Open Source</h3>
                    <p>
                        åœ¨å·¥ä¸šæ—¶ä»£ï¼Œé©¬å…‹æ€æ‰¹åˆ¤äº†<span class="highlight">ç”Ÿäº§èµ„æ–™çš„ç§æœ‰åˆ¶</span>ã€‚è€Œåœ¨ä»Šå¤©çš„æ•°å­—ä¸–ç•Œï¼Œä»£ç æˆä¸ºäº†æ–°çš„ç”Ÿäº§èµ„æ–™ã€‚
                        **å¼€æºè½¯ä»¶è¿åŠ¨ (Open Source)** æ˜¯ä¸€åœºæœªç»å®£æ‰¬çš„å…±äº§ä¸»ä¹‰å®è·µã€‚GitHub ä¸Šçš„å¼€æºä»“åº“ï¼Œå®é™…ä¸Šæ„å»ºäº†ä¸€ä¸ª<span class="highlight">æ•°å­—å…¬æœ‰åœ° (Digital Commons)</span>ã€‚
                    </p>
                </div>
            </div>
        </div>

        <!-- 3. æ·±åº¦å†…å®¹ï¼šå¼‚åŒ– -->
        <div class="section scroll-reveal">
            <div class="card-container">
                <div class="theory-card">
                    <h2>02 / ç®—æ³•å¼‚åŒ–</h2>
                    <h3>æ•°æ®æ‹œç‰©æ•™ (Data Fetishism)</h3>
                    <p>
                        é©¬å…‹æ€æå‡ºäº†â€œäººçš„å¼‚åŒ–â€ï¼šå·¥äººåˆ›é€ äº†å•†å“ï¼Œå´è¢«å•†å“æ‰€å¥´å½¹ã€‚
                        åœ¨ç®—æ³•æ—¶ä»£ï¼Œæˆ‘ä»¬é€šè¿‡ç‚¹å‡»å’Œæµè§ˆåˆ›é€ äº†æ•°æ®ï¼ˆæ•°å­—åŠ³åŠ¨ï¼‰ï¼Œä½†è¿™äº›æ•°æ®åè¿‡æ¥å˜æˆäº†æ¨èç®—æ³•ï¼ˆæ•°å­—èµ„æœ¬ï¼‰æ¥æ§åˆ¶æˆ‘ä»¬çš„å–œå¥½ã€ç”šè‡³æ€æƒ³ã€‚
                    </p>
                </div>
            </div>
        </div>

        <!-- 4. AI å¯¹è¯ -->
        <div class="section chat-section scroll-reveal">
            <h2 style="margin-bottom: 30px; color: #fff; font-size: 2rem;">
                <span style="color:var(--primary-red)">//</span> è·¨æ—¶ç©ºè¿çº¿ï¼šAsk Marx
            </h2>
            <div class="chat-container">
                <div class="chat-header">
                    <div><span class="status-dot"></span><span style="font-weight: bold;">Karl_Marx_v1.0.exe</span></div>
                    <div style="font-size: 0.8rem; color: #aaa;">Online</div>
                </div>
                <div class="chat-window" id="chat-window">
                    <div class="message ai"><strong>é©¬å…‹æ€:</strong> åŒå¿—ä½ å¥½ã€‚æˆ‘åœ¨å†å²çš„è¿·é›¾ä¸­è§‚å¯Ÿç€ä½ ä»¬çš„æ—¶ä»£ã€‚æœ‰ä½•å›°æƒ‘ï¼Ÿ</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="user-input" placeholder="è¾“å…¥é—®é¢˜..." autocomplete="off">
                    <button onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼šå¯åŠ¨æ§åˆ¶ & æ»šåŠ¨ä¿®å¤ ---
        function startExperience() {
            // 1. æ’­æ”¾éŸ³ä¹
            const audio = document.getElementById('bgm');
            audio.volume = 0.5; // éŸ³é‡ 50%
            audio.play().catch(e => console.log("æ’­æ”¾å¤±è´¥ï¼Œéœ€ç”¨æˆ·äº¤äº’", e));

            // 2. éšè—å¯åŠ¨é¡µï¼Œæ˜¾ç¤ºå†…å®¹
            const startScreen = document.getElementById('start-screen');
            const content = document.getElementById('main-content');
            
            startScreen.style.opacity = '0';
            setTimeout(() => {
                startScreen.style.display = 'none';
                content.style.opacity = '1';
                
                // 3. å…³é”®ä¸€æ­¥ï¼šé‡æ–°è®¡ç®—æ»šåŠ¨ä½ç½®ï¼ä¿®å¤æ»šåŠ¨ä¸æ˜¾ç¤ºçš„BUG
                ScrollTrigger.refresh(); 
                
                // 4. å¯åŠ¨æ‰“å­—æœº
                typeWriter();
            }, 1000);
        }

        function toggleMusic() {
            const audio = document.getElementById('bgm');
            if(audio.paused) audio.play();
            else audio.pause();
        }

        // --- 2. Three.js èƒŒæ™¯ (è½»é‡åŒ–) ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.02);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const geometry = new THREE.BufferGeometry();
        const count = 3000;
        const positions = new Float32Array(count * 3);
        const colors = new Float32Array(count * 3);
        for(let i=0; i<count*3; i++) {
            positions[i] = (Math.random()-0.5)*25; 
            colors[i] = Math.random()>0.5 ? 1 : 0.6; 
        }
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        const particles = new THREE.Points(geometry, new THREE.PointsMaterial({size:0.06, vertexColors:true, transparent:true, opacity:0.9, blending:THREE.AdditiveBlending}));
        scene.add(particles);
        camera.position.z = 5;

        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - window.innerWidth/2) * 0.0005;
            mouseY = (e.clientY - window.innerHeight/2) * 0.0005;
        });

        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += 0.001; 
            particles.rotation.y += (mouseX - particles.rotation.y) * 0.05;
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            ScrollTrigger.refresh(); // çª—å£å¤§å°æ—¶ä¹Ÿåˆ·æ–°æ»šåŠ¨
        });

        // --- 3. GSAP æ»šåŠ¨åŠ¨ç”» ---
        gsap.registerPlugin(ScrollTrigger);

        // é¡µé¢åŠ è½½å®Œæˆåå†æ¬¡å¼ºåˆ¶åˆ·æ–° ScrollTriggerï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
        window.addEventListener("load", () => {
            ScrollTrigger.refresh();
        });

        gsap.utils.toArray('.scroll-reveal').forEach(elem => {
            gsap.from(elem, {
                y: 50, opacity: 0, duration: 1, ease: "power2.out",
                scrollTrigger: { 
                    trigger: elem, 
                    start: "top 85%", // åªè¦è¿›å…¥å¯è§†åŒºåŸŸå°±æ˜¾ç¤º
                    toggleActions: "play none none reverse" 
                }
            });
        });

        // æ‰“å­—æœº
        const text = "å“²å­¦å®¶ä»¬åªæ˜¯ç”¨ä¸åŒçš„æ–¹å¼è§£é‡Šä¸–ç•Œï¼Œé—®é¢˜åœ¨äºæ”¹å˜ä¸–ç•Œã€‚";
        let typeIdx = 0;
        function typeWriter() {
            if (typeIdx < text.length) {
                document.getElementById("typewriter").innerHTML += text.charAt(typeIdx);
                typeIdx++;
                setTimeout(typeWriter, 50);
            }
        }

        // --- 4. AI å¯¹è¯ ---
        // âš ï¸ è®°å¾—å» GitHub å»º api/chat.js è§£å†³è·¨åŸŸï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºç¦»çº¿å›å¤
        const API_KEY = ""; // å‰ç«¯ç•™ç©º
        const API_URL = "/api/chat"; // ä½¿ç”¨ Vercel åç«¯

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const userText = input.value.trim();
            if (!userText) return;

            addMessage('user', userText);
            input.value = '';
            const loadingId = addMessage('ai', '<span style="opacity:0.7">æ€è€ƒä¸­...</span>');

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ ç°åœ¨æ˜¯å¡å°”Â·é©¬å…‹æ€..."}, // æç¤ºè¯çœç•¥ï¼Œä¿æŒä¹‹å‰ä¸€æ ·
                            {role: "user", content: userText}
                        ]
                    })
                });

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                updateMessage(loadingId, data.choices[0].message.content);

            } catch (error) {
                console.error(error);
                const backups = ["å†å²çš„è¾©è¯æ³•å‘Šè¯‰æˆ‘ä»¬ï¼ŒæŠ€æœ¯åº”å½“è§£æ”¾äººç±»ã€‚", "å…¨ä¸–ç•Œæ— äº§è€…ï¼Œè”åˆèµ·æ¥ï¼", "ä½ çš„å›°æƒ‘æºäºç”Ÿäº§å…³ç³»çš„ä¸åŒ¹é…ã€‚"];
                updateMessage(loadingId, backups[Math.floor(Math.random()*backups.length)] + " <br><span style='font-size:0.8rem;color:#888'>(ç¦»çº¿æ¨¡å¼)</span>");
            }
        }

        function addMessage(role, html) {
            const w = document.getElementById('chat-window');
            const d = document.createElement('div');
            d.className = `message ${role}`;
            d.id = 'msg-'+Date.now();
            d.innerHTML = role==='ai'?`<strong>é©¬å…‹æ€:</strong> ${html}`:html;
            w.appendChild(d);
            w.scrollTop = w.scrollHeight;
            return d.id;
        }
        function updateMessage(id, txt) {
            const d = document.getElementById(id);
            d.innerHTML = `<strong>é©¬å…‹æ€:</strong> ${window.marked ? marked.parseInline(txt) : txt}`;
        }
        document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key==='Enter') sendMessage(); });

    </script>
</body>
</html>
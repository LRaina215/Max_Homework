// ============================================
        // 1. Three.js 粒子特效 (背景)
        // ============================================
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.05);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const geometry = new THREE.BufferGeometry();
        const count = 3000;
        const positions = new Float32Array(count * 3);
        const colors = new Float32Array(count * 3);

        for(let i = 0; i < count * 3; i++) {
            positions[i] = (Math.random() - 0.5) * 20; 
            colors[i] = Math.random() > 0.8 ? 1 : 0.9; 
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({
            size: 0.05,
            vertexColors: true,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);
        camera.position.z = 5;

        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - window.innerWidth / 2) * 0.0005;
            mouseY = (e.clientY - window.innerHeight / 2) * 0.0005;
        });

        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += 0.002;
            particles.rotation.x += 0.001;
            particles.rotation.y += (mouseX - particles.rotation.y) * 0.05;
            particles.rotation.x += (mouseY - particles.rotation.x) * 0.05;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ============================================
        // 2. GSAP 动画 & 打字机
        // ============================================
        gsap.registerPlugin(ScrollTrigger);

        const text = "哲学家们只是用不同的方式解释世界，问题在于改变世界。";
        let typeIdx = 0;
        function typeWriter() {
            if (typeIdx < text.length) {
                document.getElementById("typewriter").innerHTML += text.charAt(typeIdx);
                typeIdx++;
                setTimeout(typeWriter, 80);
            }
        }
        setTimeout(typeWriter, 1000);

        gsap.utils.toArray('.scroll-reveal').forEach(elem => {
            gsap.from(elem, {
                y: 100, opacity: 0, duration: 1.5, ease: "power3.out",
                scrollTrigger: { trigger: elem, start: "top 80%", toggleActions: "play none none reverse" }
            });
        });

        // ============================================
        // 3. AI 对话系统 (严格对应 DeepSeek 官方文档)
        // ============================================
        
        // ⚠️ 你的 Key (保持这个不动，完全正确)
        const API_KEY = "sk-67378a51c3634e38a618d01952693fb0"; 
        
        // ✅ 严格对应文档中的 curl https://api.deepseek.com/chat/completions
        const API_URL = "https://api.deepseek.com/chat/completions"; 

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const chatWindow = document.getElementById('chat-window');
            const userText = input.value.trim();

            if (!userText) return;

            // 1. 显示用户消息
            addMessage('user', userText);
            input.value = '';

            // 2. 显示加载状态
            const loadingId = addMessage('ai', '<span style="opacity:0.7">正在翻阅《政治经济学批判》...</span>');

            try {
                // 发起请求 - 参数严格参照 curl 示例
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat", // 对应文档
                        messages: [
                            {
                                role: "system", 
                                content: "你现在是卡尔·马克思。请用19世纪哲学家的口吻，结合辩证唯物主义和政治经济学原理，回答关于现代社会（互联网、AI、内卷等）的问题。语调要严肃、充满激情且富有批判性。回答要简短有力，控制在120字以内。" 
                            },
                            { role: "user", content: userText }
                        ],
                        stream: false // 文档默认为 false，这里显式声明一下
                    })
                });

                if (!response.ok) {
                    const errInfo = await response.json();
                    throw new Error("Error " + response.status + ": " + (errInfo.error?.message || "API请求失败"));
                }

                const data = await response.json();
                const aiReply = data.choices[0].message.content;

                // 3. 成功：更新消息
                updateMessage(loadingId, aiReply);

            } catch (error) {
                console.error("AI Error:", error);
                // 4. 失败：使用备用语料 (安全网)
                const backupReply = "资本主义的防火墙似乎阻挡了我的声音。但这无法阻止真理的传播。（网络或额度异常，请检查控制台）";
                updateMessage(loadingId, backupReply);
            }
        }

        function addMessage(role, htmlContent) {
            const chatWindow = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.id = 'msg-' + Date.now();
            
            if (role === 'ai') {
                div.innerHTML = `<strong>马克思:</strong> ${htmlContent}`;
            } else {
                div.textContent = htmlContent;
            }
            
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return div.id;
        }

        function updateMessage(id, text) {
            const div = document.getElementById(id);
            // 简单处理 Markdown
            if(window.marked) {
                div.innerHTML = `<strong>马克思:</strong> ${marked.parseInline(text)}`;
            } else {
                div.innerHTML = `<strong>马克思:</strong> ${text}`;
            }
        }

        // 回车发送监听
        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });